<!DOCTYPE html>
<html>
<head>
    <title>the-retrospective</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var RETRO_CATEGORIES=[{key:"GOOD",display:"THE GOOD"},{key:"BAD",display:"THE BAD"},{key:"IDEAS",display:"THE IDEAS"},{key:"ACCLAIM",display:"THE ACCLAIM"}];Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:[{xtype:"container",itemId:"pulldown-container",layout:{type:"hbox",align:"stretch"}},{xtype:"container",itemId:"add-new-container",layout:{align:"bottom",type:"hbox"},border:0,padding:10},{xtype:"container",itemId:"item-panel-container",layout:{type:"vbox",align:"stretch"}}],itemId:"retroApp",iterationStore:void 0,retroItemsPanel:void 0,launch:function(){var me=this;console.log("our second app"),me._renderSubmissionField(),me._loadIterations()},_handleSubmitClick:function(button){var userResult=Rally.environment.getContext().getUser(),me=button.up("#retroApp"),tf=me.down("#add-new-text-box").getValue(),comboBox=me.down("#add-new-combo-box").getValue(),user="";user=me.down("#add-new-anonymous-check-box").getValue()?{name:"Anonymous",uid:-1}:{name:userResult.UserName,uid:userResult.ObjectID},console.log("New Feedback Submitted - ",tf,comboBox,user);var newRetroItem={description:tf,user:user,votes:{count:0,voted:[]},handled:!1};me.retroItems[comboBox].push(newRetroItem),me.down("#panel-"+comboBox).add(me._createItemContainer(newRetroItem)),me._updateData(),me.down("#add-new-text-box").setValue("")},_renderSubmissionField:function(){try{var me=this,itemDescription="",button=Ext.create("Rally.ui.Button",{itemId:"add-new-submit-button",text:"Add",handler:me._handleSubmitClick,disabled:!0,margin:5,flex:1}),textInput=Ext.create("Rally.ui.TextField",{itemId:"add-new-text-box",emptyText:"Enter a short description of your retro item",fieldLabel:"Add New Retro Item",labelSeparator:"",flex:10,height:40,labelAlign:"top",margin:5,listeners:{change:function(cmp,newContent){_.isEmpty(newContent)?button.disable():button.enable()},specialkey:function(field,e){e.getKey()!==e.ENTER||button.isDisabled()||me._handleSubmitClick(button)}}}),checkbox=Ext.create("Rally.ui.CheckboxField",{itemId:"add-new-anonymous-check-box",fieldLabel:"Anonymous",labelSeparator:"",value:!0,flex:1,labelAlign:"right",margin:5}),category=Ext.create("Rally.ui.combobox.ComboBox",{itemId:"add-new-combo-box",fieldLabel:"Category",flex:1,labelAlign:"top",margin:5,store:_.pluck(RETRO_CATEGORIES,"key")});me.down("#add-new-container").add(textInput),me.down("#add-new-container").add(category),me.down("#add-new-container").add(checkbox),me.down("#add-new-container").add(button)}catch(e){console.log(e)}},_loadIterations:function(){var me=this,iterComboBox=Ext.create("Rally.ui.combobox.IterationComboBox",{itemId:"iteration-combobox",fieldLabel:"Retroapptive for iteration",labelCls:"x-panel-header-text-container-default",labelAlign:"left",labelWidth:300,width:600,listeners:{ready:me._loadData,select:me._loadData,scope:me}});this.down("#pulldown-container").add(iterComboBox)},_getFilters:function(iterationValue){var iterationFilter=Ext.create("Rally.data.wsapi.Filter",{property:"ObjectID",operation:"=",value:iterationValue});return iterationFilter},_loadData:function(){var me=this,selectedIterRef=this.down("#iteration-combobox").getRecord().get("ObjectID"),myFilters=this._getFilters(selectedIterRef);console.log("Iteration Filter:",""+myFilters),me.iterationStore?(console.log("store exists"),me.iterationStore.setFilter(myFilters),me.iterationStore.load()):(console.log("creating store"),me.iterationStore=Ext.create("Rally.data.wsapi.Store",{model:"Iteration",autoLoad:!0,filters:myFilters,listeners:{load:function(myStore,myData,success){console.log(success,myStore,myData),me.retroItemsPanel||me._createGrid(myStore)},scope:me},fetch:["FormattedID","Name","Notes"]}))},_updateData:function(){try{var me=this,resultStr=JSON.stringify(me.retroItems);me.iterationStore.data.items[0].set("Notes",resultStr),me.iterationStore.data.items[0].save(),me.down("#item-panel")||me._createAccordionPanel(),console.log("Commited Changes to current Rally Iteration",me.retroItems)}catch(e){console.log(e)}},_createGrid:function(myiterationStore){var me=this;this.retroItems={};try{var iterationNotes=myiterationStore.data.items[0].data.Notes;iterationNotes?this.retroItems=JSON.parse(iterationNotes):_.forEach(RETRO_CATEGORIES,function(category){me.retroItems[category.key]=[]}),console.log("Iteration Feedback Data:",this.retroItems)}catch(e){console.log(e)}try{me.retroItemsPanel=Ext.create("Ext.panel.Panel",{itemId:"item-panel",title:"Items",defaults:{bodyStyle:"padding:15px"}})}catch(e){console.log(e)}me.down("#item-panel-container").add(me.retroItemsPanel),me._createAccordionPanel()},_handleDeleteClick:function(button){console.log("Deleting item");var retroContainer=button.up("container"),retroItem=retroContainer.retroItem,retroContainerBox=button.up("container"),me=button.up("#retroApp");console.log(me.retroItems),_.forEach(RETRO_CATEGORIES,function(category){var itemRef=_.find(me.retroItems[category.key],function(item){return _.isEqual(item,retroItem)});if(itemRef){_.remove(me.retroItems[category.key],itemRef);var panel=button.up("#panel-"+category.key);panel.remove(retroContainerBox),me._createAccordionPanel()}},button),me._updateData()},_handleVoteClick:function(button){console.log("Voting on item");var retroItem=button.up("container").retroItem,me=button.up("#retroApp"),controlsContainer=button.up("#controls-container");me._toggleButtonState(button),_.forEach(RETRO_CATEGORIES,function(category){var itemRef=_.find(me.retroItems[category.key],function(item){return _.isEqual(item,retroItem)}),voter={name:Rally.environment.getContext().getUser().UserName,uid:Rally.environment.getContext().getUser().ObjectID};if(itemRef){var userHasVoted=_.contains(_.pluck(retroItem.votes.voted,"uid"),voter.uid);if(userHasVoted){itemRef.votes.count-=1,retroItem.votes.count-=1;var voterRef=_.find(itemRef.votes.voted,function(voterRecord){return _.isEqual(voterRecord,voter)});_.remove(itemRef.votes.voted,voterRef),_.remove(retroItem.votes.voted,voterRef);var userImage=controlsContainer.down("#voterImage-image-"+voter.uid);controlsContainer.remove(userImage)}else{itemRef.votes.count+=1,retroItem.votes.count+=1,itemRef.votes.voted.push(voter),retroItem.votes.voted.push(voter);var userImage=Ext.create("Ext.Img",{itemId:"voterImage-image-"+voter.uid,src:"https://rally1.rallydev.com/slm/profile/viewThumbnailImage.sp?uid="+voter.uid,height:25,width:25,margin:1});controlsContainer.add(userImage)}button.setText(itemRef.votes.count)}}),me._updateData()},_handleHandledClick:function(button){var retroContainer=button.up("container"),retroItem=retroContainer.retroItem,me=button.up("#retroApp");me._toggleButtonState(button),_.forEach(RETRO_CATEGORIES,function(category){var itemRef=_.find(me.retroItems[category.key],function(item){return _.isEqual(item,retroItem)});itemRef&&(itemRef.handled=!itemRef.handled,retroItem.handled=!retroItem.handled)}),me._updateData()},_toggleButtonState:function(button){button.hasCls("primary")?(button.removeCls("primary"),button.addCls("secondary")):(button.removeCls("secondary"),button.addCls("primary"))},_createItemContainer:function(retroItem){var me=this;console.log(retroItem),console.log(me);var textBox=Ext.create("Ext.draw.Text",{itemId:"text-retro-item",text:retroItem.description}),button=Ext.create("Rally.ui.Button",{itemId:"delete-retro-item-button",iconCls:"icon-delete",handler:me._handleDeleteClick,align:"right",disabled:!1}),userHasVoted=_.contains(_.pluck(retroItem.votes.voted,"uid"),Rally.environment.getContext().getUser().ObjectID),votedLabelTxt=retroItem.votes.count,voteButton=Ext.create("Rally.ui.Button",{itemId:"vote-retro-item-button",cls:(userHasVoted?"primary":"secondary")+" rly-small",iconCls:"icon-thumbs-up",text:votedLabelTxt,handler:me._handleVoteClick,align:"right"}),handledButton=Ext.create("Rally.ui.Button",{itemId:"handled-retro-item-button",iconCls:"icon-ready",cls:(retroItem.handled?"primary":"secondary")+" rly-small",handler:me._handleHandledClick,added:me._setHandledButtonState,align:"right"});handledButton.applyState(retroItem.handled);var imgURI="https://help.rallydev.com/apps/2.0/doc/images/main-header-logo.png";retroItem.user.uid>0&&(imgURI="https://rally1.rallydev.com/slm/profile/viewThumbnailImage.sp?uid="+retroItem.user.uid);var submitterImage=Ext.create("Ext.Img",{itemId:"submitter-image",src:imgURI,height:25,width:25}),textSeparator=Ext.create("Ext.draw.Text",{itemId:"separatorText",text:"",width:25,layout:{align:"center"}}),items=[submitterImage,textSeparator,handledButton,button,voteButton];_.forEach(retroItem.votes.voted,function(voter){var voterImage=Ext.create("Ext.Img",{itemId:"voterImage-image-"+voter.uid,src:"https://rally1.rallydev.com/slm/profile/viewThumbnailImage.sp?uid="+voter.uid,height:25,width:25,margin:1});items.push(voterImage)});var controls=Ext.create("Ext.container.Container",{itemId:"controls-container",layout:{type:"hbox"},items:items,retroItem:retroItem});return Ext.create("Ext.container.Container",{layout:{type:"vbox"},padding:5,border:1,items:[controls,textBox]})},_createAccordionItems:function(){var me=this;return console.log(me),_.map(RETRO_CATEGORIES,function(category){return{title:category.display,itemId:"panel-"+category.key,items:_.map(me.retroItems[category.key],me._createItemContainer,me),category:category}},me)},_createAccordionPanel:function(){var me=this,accordion=me.down("#item-panel");accordion.removeAll(),_.map(me._createAccordionItems(),function(item){accordion.add(item)})}});

            Rally.launchApp('CustomApp', {
                name:"the-retrospective",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app .x-form-item-label.x-unselectable.x-form-item-label-top{text-transform:uppercase}
    </style>
</head>
<body>
</body>
</html>
