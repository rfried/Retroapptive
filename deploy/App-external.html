<!DOCTYPE html>
<html>
<head>
    <title>the-retrospective</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var RETRO_CATEGORIES=[{key:"GOOD",display:"THE GOOD"},{key:"BAD",display:"THE BAD"},{key:"IDEAS",display:"THE IDEAS"},{key:"ACCLAIM",display:"THE ACCLAIM"}];Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",padding:10,items:[{xtype:"container",itemId:"pulldown-container",layout:{type:"hbox",align:"stretch"}},{xtype:"container",itemId:"add-new-container",layout:{align:"bottom",type:"hbox"},border:0},{xtype:"container",itemId:"item-panel-container",autoScroll:!0,autoDestroy:!1,layout:{type:"vbox",align:"stretch"}}],itemId:"retroApp",iterationStore:void 0,retroItemsPanel:void 0,launch:function(){var me=this;me._renderSubmissionField(),me._loadIterations();var task={run:function(){me.iterationStore&&me.iterationStore.load()},interval:1e3};Ext.TaskManager.start(task)},_loadIterations:function(){var me=this,iterComboBox=Ext.create("Rally.ui.combobox.IterationComboBox",{itemId:"iteration-combobox",fieldLabel:"Retroapptive for iteration",labelCls:"x-panel-header-text-container-default",labelAlign:"left",labelWidth:300,width:600,listeners:{ready:me._loadData,select:function(){me.loadedInitialData=!1,me._loadData()},scope:me}});this.down("#pulldown-container").add(iterComboBox)},_getFilters:function(iterationValue){var iterationFilter=Ext.create("Rally.data.wsapi.Filter",{property:"ObjectID",operation:"=",value:iterationValue});return iterationFilter},_loadData:function(){var me=this,selectedIterRef=this.down("#iteration-combobox").getRecord().get("ObjectID"),myFilters=this._getFilters(selectedIterRef);me.iterationStore?(me.iterationStore.setFilter(myFilters),me.iterationStore.load()):me.iterationStore=Ext.create("Rally.data.wsapi.Store",{model:"Iteration",autoLoad:!0,filters:myFilters,listeners:{load:function(myStore,myData,success){me._readRetroItems(),me.loadedInitialData||(me._renderRetroItems(),me.loadedInitialData=!0)},scope:me},fetch:["FormattedID","Name","Notes"]})},_renderSubmissionField:function(){try{var me=this,itemDescription="",button=Ext.create("Rally.ui.Button",{itemId:"add-new-submit-button",text:"Add",handler:me._handleSubmitClick,disabled:!0,margin:5,flex:1}),textInput=Ext.create("Rally.ui.TextField",{itemId:"add-new-text-box",emptyText:"Enter a short description of your retro item",fieldLabel:"ADD NEW RETRO ITEM",labelSeparator:"",flex:8,height:40,labelAlign:"top",margin:5,listeners:{change:function(cmp,newContent){_.isEmpty(newContent)?button.disable():button.enable()},specialkey:function(field,e){e.getKey()!==e.ENTER||button.isDisabled()||me._handleSubmitClick(button)}}}),checkbox=Ext.create("Rally.ui.CheckboxField",{itemId:"add-new-anonymous-check-box",fieldLabel:"Anonymous",labelSeparator:"",value:!0,flex:1,labelAlign:"right",margin:5}),category=Ext.create("Rally.ui.combobox.ComboBox",{itemId:"add-new-combo-box",fieldLabel:"CATEGORY",flex:1,labelAlign:"top",margin:5,store:_.pluck(RETRO_CATEGORIES,"key")});me.down("#add-new-container").add(textInput),me.down("#add-new-container").add(category),me.down("#add-new-container").add(checkbox),me.down("#add-new-container").add(button)}catch(e){console.log(e)}},_renderRetroItems:function(){var me=this;me._addDefaultRetroCategoryPanels();var existingRetroItemContainers=[];me.down("#item-panel").items&&_.forEach(me.down("#item-panel").items.items,function(categoryPanel){categoryPanel.items&&_.forEach(categoryPanel.items.items,function(retroItemContainer){me._getRetroItemRef(retroItemContainer.retroItem)||existingRetroItemContainers.push(retroItemContainer)},me)},me),_.forEach(existingRetroItemContainers,function(retroItemContainer){me._deleteRetroItemContainer(retroItemContainer.retroItem)}),_.forEach(me.retroItemsArray,function(retroItem){var retroItemContainerRef=me._getRetroItemContainerRef(retroItem);retroItemContainerRef?me._updateRetroItemContainer(retroItem):me._addRetroItemContainer(retroItem)})},_createItemContainer:function(retroItem){var me=this,textBox={border:0,marginTop:0,html:'<div style="font-size: 13px;">'+retroItem.description+"</div>"},button=Ext.create("Rally.ui.Button",{itemId:"delete-retro-item-button",iconCls:"icon-delete",cls:"secondary rly-small",handler:me._handleDeleteClick,align:"right",disabled:!1}),user={name:Rally.environment.getContext().getUser().UserName,uid:Rally.environment.getContext().getUser().ObjectID},userHasVoted=_.contains(_.pluck(retroItem.voters,"uid"),user.uid),votedLabelTxt=retroItem.voters?retroItem.voters.length:"",voteButton=Ext.create("Rally.ui.Button",{itemId:"vote-retro-item-button",cls:(userHasVoted?"primary":"secondary")+" rly-small",iconCls:"icon-thumbs-up",text:votedLabelTxt,handler:me._handleVoteClick,align:"right"}),handledButton=Ext.create("Rally.ui.Button",{itemId:"handled-retro-item-button",iconCls:"icon-ready",cls:(retroItem.handled?"primary":"secondary")+" rly-small",handler:me._handleHandledClick,added:me._setHandledButtonState,align:"right"});handledButton.applyState(retroItem.handled);var imgURI="https://help.rallydev.com/apps/2.0/doc/images/main-header-logo.png";retroItem.user&&retroItem.user.uid>0&&(imgURI="https://rally1.rallydev.com/slm/profile/viewThumbnailImage.sp?uid="+retroItem.user.uid);var submitterImage=Ext.create("Ext.Img",{itemId:"submitter-image",src:imgURI,height:25,width:25}),textSeparator=Ext.create("Ext.draw.Text",{itemId:"separatorText",text:"",width:25,layout:{align:"center"}}),items=[submitterImage,textSeparator,handledButton,button,voteButton];_.forEach(retroItem.voters,function(voter){var voterImage=Ext.create("Ext.Img",{itemId:"voterImage-image-"+voter.uid,src:"https://rally1.rallydev.com/slm/profile/viewThumbnailImage.sp?uid="+voter.uid,height:25,width:25,margin:1});items.push(voterImage)});var controls=Ext.create("Ext.container.Container",{itemId:"controls-container",layout:{type:"hbox"},items:items,retroItem:retroItem});return Ext.create("Ext.container.Container",{layout:{type:"vbox"},itemId:"retro-item-container-"+retroItem.id,padding:5,border:1,items:[controls,textBox],retroItem:retroItem})},_createRetroItemPanel:function(panelId){var me=this;return Ext.create("Ext.panel.Panel",{itemId:panelId,margin:"10 0 0 0",border:!1,defaults:{bodyStyle:"padding:15px"}})},_createRetroItemCategoryPanel:function(panelId,category,categoryDisplay){var me=this;return Ext.create("Ext.panel.Panel",{title:categoryDisplay,itemId:panelId,category:category})},_addRetroItemsPanel:function(){var me=this,retroItemsPanel=me.down("#item-panel");try{retroItemsPanel||(retroItemsPanel=me._createRetroItemPanel("item-panel"),retroItemsPanel=me.down("#item-panel-container").add(retroItemsPanel))}catch(e){console.log(e)}return retroItemsPanel},_addRetroItemCategoryPanel:function(category){var me=this,retroItemCategoryPanel=me.down("#panel-"+category);try{var retroItemPanel=me._addRetroItemsPanel(),categoryConstant=_.find(RETRO_CATEGORIES,function(cat){return cat.key==category});if(retroItemPanel&&!retroItemCategoryPanel){var categoryDisplay=categoryConstant?categoryConstant.display:category;retroItemCategoryPanel=me._createRetroItemCategoryPanel("panel-"+category,category,categoryDisplay),retroItemPanel.add(retroItemCategoryPanel)}}catch(e){console.log(e)}return retroItemCategoryPanel},_addDefaultRetroCategoryPanels:function(){var me=this,retroCategoryPanels=[];return _.forEach(RETRO_CATEGORIES,function(category){retroCategoryPanels.push(me._addRetroItemCategoryPanel(category.key))},me),retroCategoryPanels},_addRetroItemContainer:function(retroItem){var me=this,retroItemContainerRef={};try{var retroItemPanel=me._addRetroItemsPanel(),retroItemCategoryPanel=me._addRetroItemCategoryPanel(retroItem.category);if(retroItemContainerRef=me._getRetroItemContainerRef(retroItem),!retroItemContainerRef){var retroItemContainer=me._createItemContainer(retroItem),insertionIndex=_.sortedIndex(retroItemCategoryPanel.items.items,retroItemContainer,"retroItem.timestamp");retroItemContainerRef=retroItemCategoryPanel.insert(insertionIndex,retroItemContainer)}}catch(e){console.log(e)}return retroItemContainerRef},_updateRetroItemContainer:function(retroItem){var me=this,retroItemContainerRef={};try{if(retroItemContainerRef=me._getRetroItemContainerRef(retroItem)){var retroItemRef=me._getRetroItemRef(retroItem);if(!_.isEqual(retroItemRef,retroItemContainerRef.retroItem)){var retroItemContainer=me._createItemContainer(retroItem),parentContainer=retroItemContainerRef.up(),retroItemContainerIndex=_.findIndex(parentContainer.items.items,function(container){return retroItemContainerRef.itemId==container.itemId});parentContainer.remove(retroItemContainerRef),parentContainer.insert(retroItemContainerIndex,retroItemContainer)}}}catch(e){console.log(e)}return retroItemContainerRef},_deleteRetroItemContainer:function(retroItem){var me=this,retroItemContainerRef={};try{if(retroItemContainerRef=me._getRetroItemContainerRef(retroItem)){var retroItemCategoryPanelRef=retroItemContainerRef.up("#panel-"+retroItem.category);retroItemCategoryPanelRef.remove(retroItemContainerRef)}}catch(e){console.log(e)}return retroItemContainerRef},_getRetroItemContainerRef:function(retroItem){var me=this,retroContainerRef=me.down("#retro-item-container-"+retroItem.id);return retroContainerRef},_readRetroItems:function(){var me=this;me.retroItemsArray=[];try{if(me.iterationStore){var iterationNotes=me.iterationStore.data.items[0].data.Notes;iterationNotes&&(me.retroItemsArray=JSON.parse(iterationNotes),_.sortBy(me.retroItemsArray,"timestamp"))}}catch(e){console.log(e)}},_addRetroItem:function(retroItem){var me=this;me._readRetroItems();var insertionIndex=_.sortedIndex(me.retroItemsArray,retroItem,"timestamp");me.retroItemsArray.splice(insertionIndex,0,retroItem),me._writeRetroItems()},_updateRetroItem:function(retroItem){var me=this;me._readRetroItems();var retroItemRef=me._getRetroItemRef(retroItem);if(retroItemRef){var insertionIndex=_.indexOf(me.retroItemsArray,retroItemRef);_.remove(me.retroItemsArray,retroItemRef),me.retroItemsArray.splice(insertionIndex,0,retroItem),me._writeRetroItems()}},_deleteRetroItem:function(retroItem){var me=this;me._readRetroItems();var retroItemRef=me._getRetroItemRef(retroItem);retroItemRef&&(_.remove(me.retroItemsArray,retroItemRef),me._writeRetroItems())},_getRetroItemRef:function(retroItem){var me=this;me._readRetroItems();var retroItemRef=_.find(me.retroItemsArray,function(_retroItem){return _.isEqual(_retroItem.id,retroItem.id)});return retroItemRef},_writeRetroItems:function(){try{var me=this,resultStr=JSON.stringify(me.retroItemsArray);me.iterationStore.data.items[0].set("Notes",resultStr),me.iterationStore.data.items[0].save()}catch(e){console.log(e)}},_handleSubmitClick:function(button){var userResult=Rally.environment.getContext().getUser(),me=button.up("#retroApp"),tf=me.down("#add-new-text-box").getValue(),comboBox=me.down("#add-new-combo-box").getValue(),user="";user=me.down("#add-new-anonymous-check-box").getValue()?{name:"Anonymous",uid:-1}:{name:userResult.UserName,uid:userResult.ObjectID};var newRetroItem={id:me._UUID.generate(),category:comboBox,description:tf,user:user,voters:[],handled:!1,timestamp:Date.now()};me._addRetroItem(newRetroItem),me._renderRetroItems(),me.down("#add-new-text-box").setValue("")},_handleDeleteClick:function(button){var me=button.up("#retroApp"),retroItem=button.up("container").retroItem;me._deleteRetroItem(retroItem),me._deleteRetroItemContainer(retroItem),me._renderRetroItems()},_handleVoteClick:function(button){var me=button.up("#retroApp"),controlsContainer=button.up("container"),retroItem=controlsContainer.retroItem;me._readRetroItems();var retroItemRef=me._getRetroItemRef(retroItem);if(retroItemRef)if(_.isEqual(retroItem,retroItemRef)){var user={name:Rally.environment.getContext().getUser().UserName,uid:Rally.environment.getContext().getUser().ObjectID},userHasVoted=_.contains(_.pluck(retroItemRef.voters,"uid"),user.uid);if(userHasVoted){var voterRef=_.find(retroItemRef.voters,function(voterRecord){return _.isEqual(voterRecord,user)});_.remove(retroItemRef.voters,voterRef)}else retroItemRef.voters.push(user);me._updateRetroItem(retroItemRef)}else alert("Another user updated this item in another session.  Please try your operation again now.");else alert("Retrospective item was deleted in another session.  Sorry for the inconvenience");me._renderRetroItems()},_handleHandledClick:function(button){var me=button.up("#retroApp"),controlsContainer=button.up("container"),retroItem=controlsContainer.retroItem;me._readRetroItems();var retroItemRef=me._getRetroItemRef(retroItem),retroItemContainerRef=me._getRetroItemContainerRef(retroItem);retroItemRef?(_.isEqual(retroItem,retroItemRef)?(retroItemRef.handled=!retroItemRef.handled,me._updateRetroItem(retroItemRef)):alert("Another user updated this item in another session.  Please try your operation again now."),me._setButtonState(button,retroItemRef.handled),retroItemContainerRef.retroItem=retroItemRef):(alert("Retrospective item was deleted in another session.  Sorry for the inconvenience"),me._renderRetroItems())},_setButtonState:function(button,stateBool){stateBool?(button.removeCls("secondary"),button.addCls("primary")):(button.removeCls("primary"),button.addCls("secondary"))},_toggleButtonState:function(button){button.hasCls("primary")?(button.removeCls("primary"),button.addCls("secondary")):(button.removeCls("secondary"),button.addCls("primary"))},_UUID:{h:function(n){return(0|n).toString(16)},s:function(n){return this.h(Math.random()*(1<<(n<<2))^Date.now()).slice(-n)},generate:function(){return[this.s(4)+this.s(4),this.s(4),"4"+this.s(3),this.h(8|4*Math.random())+this.s(3),Date.now().toString(16).slice(-10)+this.s(2)].join("-")}}});

            Rally.launchApp('CustomApp', {
                name:"the-retrospective",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app .x-form-item-label.x-unselectable.x-form-item-label-top{text-transform:uppercase}
    </style>
</head>
<body>
</body>
</html>
